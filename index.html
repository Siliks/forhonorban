<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ğŸ”¹ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBeS-SDFEkQ-eh8EeqvI0qK2so020ddfA",
  authDomain: "forhonorban.firebaseapp.com",
  databaseURL: "https://forhonorban-default-rtdb.firebaseio.com",
  projectId: "forhonorban",
  storageBucket: "forhonorban.appspot.com",
  messagingSenderId: "878364292748",
  appId: "1:878364292748:web:ab3bd412f2368a0dc22da9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ğŸ”¹ Hero list
const heroes = [
  "Warden","Peacekeeper","Centurion","Black Prior",
  "Conqueror","Lawbringer","Gladiator","Warmonger",
  "Raider","Berserker","Highlander","Jormungandr",
  "Valkyrie","Warlord","Shaman",
  "Kensei","Orochi","Shugoki","Nobushi",
  "Shinobi","Aramusha","Hitokiri","Kyoshin",
  "Tiandi","Jiang Jun","Nuxia","Shaolin",
  "Pirate","Medjay","Afeera","Ocelotl"
];

// ğŸ”¹ DOM references
const heroDiv = document.getElementById("heroes");
const phaseText = document.getElementById("phase");
const p1List = document.getElementById("p1");
const p2List = document.getElementById("p2");
const playerIndicator = document.getElementById("playerIndicator");

let room = null;
let player = null;

// ğŸ”¹ Join / create room
window.joinRoom = async () => {
  room = document.getElementById("roomId").value.trim();
  if (!room) return alert("Enter a room code");

  const roomRef = ref(db, `rooms/${room}`);
  const snap = await get(roomRef);
  const data = snap.val();

  if (!data) {
    await set(roomRef, { phase: "defender", p1: [], p2: [] });
    player = "defender";
  } else if (!data.p1 || data.p1.length === 0) {
    player = "defender";
  } else if (!data.p2 || data.p2.length === 0) {
    player = "attacker";
  } else {
    return alert("Room is full!");
  }

  // Listen for real-time updates
  onValue(roomRef, snap => {
    const newData = snap.val();
    render(newData);
  });
};

// ğŸ”¹ Render UI
function render(data) {
  // Player indicator
  playerIndicator.textContent = player ? `You are ${player.toUpperCase()}` : "";

  // Ban lists
  p1List.innerHTML = data.p1.map(h => `<li class="defender-ban">${h}</li>`).join("");
  p2List.innerHTML = data.p2.map(h => `<li class="attacker-ban">${h}</li>`).join("");

  // Phase text
  if (data.phase === "defender") phaseText.textContent = "Defender banning";
  else if (data.phase === "attacker") phaseText.textContent = "Attacker banning";
  else phaseText.textContent = "Ban phase complete";

  // Render hero grid
  heroDiv.innerHTML = "";
  heroes.forEach(hero => {
    const d = document.createElement("div");
    d.className = "hero";
    d.textContent = hero;

    if (data.p1.includes(hero)) {
      d.classList.add("banned", "defender"); // Defender banned hero
    } else if (data.p2.includes(hero)) {
      d.classList.add("banned", "attacker"); // Attacker banned hero
    }

    d.onclick = () => banHero(hero, data);
    heroDiv.appendChild(d);
  });
}

// ğŸ”¹ Handle banning
function banHero(hero, data) {
  if (data.p1.includes(hero) || data.p2.includes(hero)) return;
  if (data.phase !== player) return alert("Not your turn");

  const updates = {};
  if (player === "defender" && data.p1.length < 2) {
    updates.p1 = [...data.p1, hero];
    if (updates.p1.length === 2) updates.phase = "attacker";
  } 
  if (player === "attacker" && data.p2.length < 2) {
    updates.p2 = [...data.p2, hero];
    if (updates.p2.length === 2) updates.phase = "done";
  }

  update(ref(db, `rooms/${room}`), updates);
}
</script>
