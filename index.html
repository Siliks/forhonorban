<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBeS-SDFEkQ-eh8EeqvI0qK2so020ddfA",
  authDomain: "forhonorban.firebaseapp.com",
  databaseURL: "https://forhonorban-default-rtdb.firebaseio.com",
  projectId: "forhonorban",
  storageBucket: "forhonorban.appspot.com",
  messagingSenderId: "878364292748",
  appId: "1:878364292748:web:ab3bd412f2368a0dc22da9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const heroes = [
  "Warden","Peacekeeper","Centurion","Black Prior",
  "Conqueror","Lawbringer","Gladiator","Warmonger",
  "Raider","Berserker","Highlander","Jormungandr",
  "Valkyrie","Warlord","Shaman",
  "Kensei","Orochi","Shugoki","Nobushi",
  "Shinobi","Aramusha","Hitokiri","Kyoshin",
  "Tiandi","Jiang Jun","Nuxia","Shaolin",
  "Pirate","Medjay","Afeera","Ocelotl"
];

const heroDiv = document.getElementById("heroes");
const phaseText = document.getElementById("phase");
const p1List = document.getElementById("p1");
const p2List = document.getElementById("p2");
const playerIndicator = document.getElementById("playerIndicator");
const resetBtn = document.getElementById("resetBtn");
const resetIndicator = document.getElementById("resetIndicator");

let room = null;
let player = null;

// Session ID
let sessionId = localStorage.getItem("sessionId");
if (!sessionId) {
  sessionId = Math.random().toString(36).substring(2, 10);
  localStorage.setItem("sessionId", sessionId);
}

window.joinRoom = async () => {
  room = document.getElementById("roomId").value.trim();
  if (!room) return alert("Enter a room code");

  const roomRef = ref(db, `rooms/${room}`);
  const snap = await get(roomRef);
  let data = snap.val();

  if (!data) {
    // Create room if not exists
    await set(roomRef, { phase: "defender", p1: [], p2: [], players: { [sessionId]: "defender" }, resetRequests: {} });
    player = "defender";
    data = { phase: "defender", p1: [], p2: [], players: { [sessionId]: "defender" }, resetRequests: {} };
  } else {
    if (!data.players) data.players = {};
    // Assign role if not already
    if (!data.players[sessionId]) {
      if (!Object.values(data.players).includes("defender")) data.players[sessionId] = "defender";
      else if (!Object.values(data.players).includes("attacker")) data.players[sessionId] = "attacker";
      else return alert("Room is full!");
      await update(roomRef, { players: data.players });
    }
    player = data.players[sessionId];

    if (!data.p1) data.p1 = [];
    if (!data.p2) data.p2 = [];
    if (!data.resetRequests) data.resetRequests = {};
  }

  setupRoomListener(roomRef);
  render(data);
};

// Render heroes and ban lists
function render(data) {
  playerIndicator.textContent = player ? `You are ${player.toUpperCase()}` : "";

  p1List.innerHTML = (data.p1 || []).map(h => `<li class="defender-ban">${h}</li>`).join("");
  p2List.innerHTML = (data.p2 || []).map(h => `<li class="attacker-ban">${h}</li>`).join("");

  if (data.phase === "defender") phaseText.textContent = "Defender banning";
  else if (data.phase === "attacker") phaseText.textContent = "Attacker banning";
  else phaseText.textContent = "Ban phase complete";

  heroDiv.innerHTML = "";
  heroes.forEach(hero => {
    const d = document.createElement("div");
    d.className = "hero";
    d.textContent = hero;

    if ((data.p1 || []).includes(hero)) d.classList.add("banned", "defender");
    else if ((data.p2 || []).includes(hero)) d.classList.add("banned", "attacker");

    d.onclick = () => banHero(hero, data);
    heroDiv.appendChild(d);
  });
}

// Ban a hero
function banHero(hero, data) {
  if ((data.p1 || []).includes(hero) || (data.p2 || []).includes(hero)) return;
  if (data.phase !== player) return alert("Not your turn");

  const updates = {};
  if (player === "defender" && (data.p1 || []).length < 2) {
    updates.p1 = [...(data.p1 || []), hero];
    if (updates.p1.length === 2) updates.phase = "attacker";
  }
  if (player === "attacker" && (data.p2 || []).length < 2) {
    updates.p2 = [...(data.p2 || []), hero];
    if (updates.p2.length === 2) updates.phase = "done";
  }

  update(ref(db, `rooms/${room}`), updates);
}

// Request reset (requires both players)
async function requestReset() {
  if (!room || !player) return alert("Join a room first");

  const roomRef = ref(db, `rooms/${room}`);

  runTransaction(roomRef, (data) => {
    if (!data) return data;
    if (!data.players) data.players = {};
    if (!data.resetRequests) data.resetRequests = {};

    data.players[sessionId] = player;        // ensure player registered
    data.resetRequests[sessionId] = true;    // mark this player requested reset

    const playerIds = Object.keys(data.players);
    const allRequested = playerIds.every(id => data.resetRequests[id]);

    if (allRequested) {
      data.p1 = [];
      data.p2 = [];
      data.phase = "defender";
      data.resetRequests = {}; // clear requests after reset
    }

    return data;
  });
}

// Listen for real-time updates
function setupRoomListener(roomRef) {
  onValue(roomRef, (snap) => {
    const data = snap.val();
    if (!data) return;

    render(data);

    // Update reset indicator
    if (data.resetRequests) {
      const clickedRoles = Object.keys(data.resetRequests)
        .map(id => data.players[id])
        .filter(Boolean);

      if (clickedRoles.length > 0) {
        resetIndicator.textContent = `Players requested reset: ${clickedRoles.map(r => r.toUpperCase()).join(", ")}`;
        resetBtn.textContent = "Waiting for other player...";
        resetBtn.style.background = "#f59e0b"; // orange
      } else {
        resetIndicator.textContent = "";
        resetBtn.textContent = "Reset Bans";
        resetBtn.style.background = "#1d4ed8"; // blue
      }
    } else {
      resetIndicator.textContent = "";
      resetBtn.textContent = "Reset Bans";
      resetBtn.style.background = "#1d4ed8"; // blue
    }
  });
}
</script>
