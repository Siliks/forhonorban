<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  onValue,
  update,
  runTransaction,
  get
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyBeS-SDFEkQ-eh8EeqvI0qK2so020ddfA",
  authDomain: "forhonorban.firebaseapp.com",
  databaseURL: "https://forhonorban-default-rtdb.firebaseio.com",
  projectId: "forhonorban",
  storageBucket: "forhonorban.appspot.com",
  messagingSenderId: "878364292748",
  appId: "1:878364292748:web:ab3bd412f2368a0dc22da9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= DOM ================= */

const heroDiv = document.getElementById("heroes");
const phaseText = document.getElementById("phase");
const p1List = document.getElementById("p1");
const p2List = document.getElementById("p2");
const playerIndicator = document.getElementById("playerIndicator");
const resetBtn = document.getElementById("resetBtn");
const resetIndicator = document.getElementById("resetIndicator");

/* ================= SESSION ================= */

let room = null;
let player = null;

let sessionId = localStorage.getItem("sessionId");
if (!sessionId) {
  sessionId = Math.random().toString(36).slice(2, 10);
  localStorage.setItem("sessionId", sessionId);
}

/* ================= HEROES ================= */

const heroes = [
  "Warden","Peacekeeper","Centurion","Black Prior",
  "Conqueror","Lawbringer","Gladiator","Warmonger",
  "Raider","Berserker","Highlander","Jormungandr",
  "Valkyrie","Warlord","Shaman","Varagian Guard",
  "Kensei","Orochi","Shugoki","Nobushi",
  "Shinobi","Aramusha","Hitokiri","Kyoshin","Sohei",
  "Tiandi","Jiang Jun","Nuxia","Shaolin",
  "Pirate","Medjay","Afeera","Ocelotl","Khatun","Virtuosa",
];

/* ================= JOIN ROOM ================= */

window.joinRoom = async () => {
  room = document.getElementById("roomId").value.trim();
  if (!room) return alert("Enter a room code");

  const roomRef = ref(db, `rooms/${room}`);
  const snap = await get(roomRef);
  let data = snap.val();

  if (!data) {
    await set(roomRef, {
      phase: "defender",
      p1: [],
      p2: [],
      players: { [sessionId]: "defender" },
      resetRequests: {}
    });
    player = "defender";
  } else {
    data.players ??= {};

    if (!data.players[sessionId]) {
      if (!Object.values(data.players).includes("defender")) {
        data.players[sessionId] = "defender";
      } else if (!Object.values(data.players).includes("attacker")) {
        data.players[sessionId] = "attacker";
      } else {
        return alert("Room is full");
      }
      await update(roomRef, { players: data.players });
    }

    player = data.players[sessionId];
  }

  onValue(roomRef, (snap) => {
    const state = snap.val();
    if (state) {
      render(state);
      updateResetIndicator(state);
    }
  });
};

/* ================= RENDER ================= */

function render(data) {
  playerIndicator.textContent = `You are ${player.toUpperCase()}`;

  p1List.innerHTML = (data.p1 || [])
    .map(h => `<li class="defender-ban">${h}</li>`).join("");

  p2List.innerHTML = (data.p2 || [])
    .map(h => `<li class="attacker-ban">${h}</li>`).join("");

  phaseText.textContent =
    data.phase === "defender" ? "Defender banning" :
    data.phase === "attacker" ? "Attacker banning" :
    "Ban phase complete";

  heroDiv.innerHTML = "";

  heroes.forEach(hero => {
    const div = document.createElement("div");
    div.className = "hero";
    div.textContent = hero;

    const banned =
      (data.p1 || []).includes(hero) ||
      (data.p2 || []).includes(hero);

    if (banned) div.classList.add("banned");

    if (data.phase !== player || data.phase === "done" || banned) {
      div.classList.add("disabled");
    } else {
      div.onclick = () => banHero(hero);
    }

    heroDiv.appendChild(div);
  });
}

/* ================= BAN HERO (SAFE) ================= */

function banHero(hero) {
  const roomRef = ref(db, `rooms/${room}`);

  runTransaction(roomRef, (data) => {
    if (!data || data.phase !== player) return data;

    data.p1 ??= [];
    data.p2 ??= [];

    if (data.p1.includes(hero) || data.p2.includes(hero)) return data;

    if (player === "defender" && data.p1.length < 2) {
      data.p1.push(hero);
      if (data.p1.length === 2) data.phase = "attacker";
    }

    if (player === "attacker" && data.p2.length < 2) {
      data.p2.push(hero);
      if (data.p2.length === 2) data.phase = "done";
    }

    return data;
  });
}

/* ================= RESET ================= */

function requestReset() {
  if (!room) return;

  const roomRef = ref(db, `rooms/${room}`);

  runTransaction(roomRef, (data) => {
    if (!data || data.phase !== "done") return data;

    data.resetRequests ??= {};
    data.resetRequests[sessionId] = true;

    const players = Object.keys(data.players || {});
    const ready = players.every(id => data.resetRequests[id]);

    if (ready) {
      data.p1 = [];
      data.p2 = [];
      data.phase = "defender";
      data.resetRequests = {};
    }

    return data;
  });
}

/* ================= RESET UI ================= */

function updateResetIndicator(data) {
  if (data.resetRequests && Object.keys(data.resetRequests).length > 0) {
    const roles = Object.keys(data.resetRequests)
      .map(id => data.players[id]?.toUpperCase())
      .filter(Boolean);

    resetIndicator.textContent =
      `Reset requested by: ${roles.join(", ")}`;

    resetBtn.textContent = "Waiting for other playerâ€¦";
    resetBtn.style.background = "#f59e0b";
  } else {
    resetIndicator.textContent = "";
    resetBtn.textContent = "Reset Bans";
    resetBtn.style.background = "#2563eb";
  }
}

resetBtn.addEventListener("click", requestReset);
</script>
